#!/bin/bash
set -e

apt-get update -y
apt-get install -y nginx {{ mysql_client_pkg }}

cat >/etc/nginx/sites-available/default <<'NGINX'
server {
    listen {{ nginx_listen_port }};
    server_name {{ nginx_server_name }};
    root /var/www/html;
    index index.html;
    location / {
        try_files $uri $uri/ =404;
    }
}
NGINX

mkdir -p /var/www/html
cat >/var/www/html/index.html <<'HTML'
<!doctype html>
<html lang="pt-br">
<head><meta charset="utf-8"><title>{{ site_title }}</title></head>
<body>
  <h1>{{ site_title }}</h1>
  <p>{{ site_message }}</p>
  <p>Vers√£o do site: <strong>{{ site_version }}</strong></p>
</body>
</html>
HTML
chown -R {{ app_user }}:{{ app_group }} /var/www/html

DATABASE_URL="mysql://{{ rds_username }}:{{ rds_password }}@{{ rds_endpoint }}:{{ rds_port }}/{{ rds_db_name }}?charset=utf8mb4"
echo "DATABASE_URL=\"$DATABASE_URL\"" > {{ env_file_path }}
chmod 600 {{ env_file_path }}

cat >/etc/systemd/system/{{ env_service_name }}.service <<'UNIT'
[Unit]
Description=Load td_app_env into systemd environment
After=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
EnvironmentFile={{ env_file_path }}
ExecStart=/bin/true

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable {{ env_service_name }}
systemctl start {{ env_service_name }}
systemctl restart nginx